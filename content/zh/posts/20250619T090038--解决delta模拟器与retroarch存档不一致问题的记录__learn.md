---
title:      "解决Delta模拟器与RetroArch存档不一致问题的记录"
date:       2025-06-19T09:00:38+08:00
tags:       ["learn"]
identifier: "20250619T090038"
draft: true
---

### 解决Delta模拟器与RetroArch存档不一致问题的记录

之前，我一直在手机上的Delta模拟器玩NDS游戏，最近则更多地切换到电脑上的
RetroArch。由于不想放弃之前的存档，我打算迁移文档。于是，就有了这次我
的解决迁移问题过程的记录。

首先，Delta模拟器上运行NDS游戏使用的是melonDS核心，而我平时在RetroArch
上用的是DeSmuME。起初，我打算在RetroArch上也使用melonDS，这样就可以避
免跨核心的问题。然而，令我没想到的是，我的RetroArch在打开melonDS时居然
报错了。查看错误日志后，发现是melonDS在尝试打开共享内存时遇到了权限问
题。即使在向ChatGPT和Gemini请教后，问题仍然没有得到解决。

**错误日志：**

```
[libretro ERROR] [melonDS] Failed to open memory using shm_open! (Operation not permitted)
```

于是，我又回到了跨核心共享存档的问题。通过查看DeSmuME下的存档文件，我
发现它们的格式是dsv，貌似不同核心在NDS上的存档格式是一样的。既然如此，
理论上应该可以共享存档。于是，我的第一步是直接将Delta模拟器的存档文件
复制到DeSmuME的存档目录下。

但是，当我打开游戏时，发现存档消失了。虽然存档文件依然存在，且格式正确，
但存档就是加载不出来。为了查明原因，我决定重新命名一份NDS文件，再次启
动游戏，生成一个新的存档。通过对比两个存档文件，我发现它们的文件大小有
细微的差异。由于这两个文件都是二进制格式的，我无法直接查看差异。所以需
要把二进制文件转成十六进制，再用文本编辑器来查看文件的差异。于是，我使
用`hexdump`命令将存档文件转换为十六进制格式，然后使用`diff`工具进行比
较。

经过一番分析，我发现DeSmuME生成的存档文件末尾多出了一段小尾巴，这段内
容正是导致文件大小差异的原因。于是，我将这段小尾巴从DeSmuME生成的存档
中提取出来，并将它附加到原始的Delta存档的十六进制数据末尾。接着，我使
用`hexdump -r`命令将修改后的十六进制数据重新转换为二进制文件。

接下来就是见证奇迹的时刻了，重新打开游戏，出现原来的存档了。Bingo！

```
00010000: 7c3c 2d2d 536e 6970 2061 626f 7665 2068  |<--Snip above h
00010010: 6572 6520 746f 2063 7265 6174 6520 6120  ere to create a
00010020: 7261 7720 7361 7620 6279 2065 7863 6c75  raw sav by exclu
00010030: 6469 6e67 2074 6869 7320 4465 536d 754d  ding this DeSmuM
00010040: 4520 7361 7665 6461 7461 2066 6f6f 7465  E savedata foote
00010050: 723a 01b8 0000 0000 0100 0300 0000 0200  r:..............
00010060: 0000 0000 0100 0000 0000 7c2d 4445 534d  ..........|-DESM
00010070: 554d 4520 5341 5645 2d7c                 UME SAVE-|
```
